service: calbright-trigger-workflow
plugins:
  - serverless-python-requirements
package:
  exclude:
    - env/**
    - node_modules/**
provider:
  name: aws
  runtime: python3.9
  region: us-west-2
  stage: ${env:ENVIRONMENT}
  timeout: 60 # in Seconds
  memorySize: 256 # in MB
  deploymentBucket:
    name: serverless.calbright.deploys # Deployment bucket name. Default is generated by the framework
  iamRoleStatements:
    - Effect: Allow
      Action:
        - kms:*
      Resource:
        - arn:aws:kms:us-west-2:523292522460:key/69776fb9-cbe2-489c-8efe-1dd896aeab68
    - Effect: Allow
      Action:
        - ssm:GetParameter
        - ssm:GetParameters
      Resource:
        - arn:aws:ssm:us-west-2:523292522460:parameter/psql.calbright.${env:ENVIRONMENT}.write
        - arn:aws:ssm:us-west-2:523292522460:parameter/anthology.${env:ENVIRONMENT}
    - Effect: Allow
      Action:
        - sqs:GetQueueUrl
        - sqs:SendMessage
      Resource:
        - arn:aws:sqs:us-west-2:523292522460:calbright_triggers_${env:ENVIRONMENT}.fifo
    - Effect: Allow
      Action:
        - sqs:*
      Resource:
        - arn:aws:sqs:us-west-2:523292522460:calbright_triggers_${env:ENVIRONMENT}_dlq.fifo        
  stackTags:
    Name: calbright-trigger-workflow-system-${env:ENVIRONMENT}-lambda
    Environment: ${env:ENVIRONMENT}
functions:
  lambda:
    handler: handler.run
    description: (${env:ENVIRONMENT}) Calbright Workflow System listening to calbright triggers queue
    events:
      - sqs: arn:aws:sqs:us-west-2:523292522460:calbright_triggers_${env:ENVIRONMENT}.fifo
    environment:
      ENV: ${env:ENVIRONMENT}
      PRINT_EVENT: true
    vpc:
      securityGroupIds:
        - sg-03509e4c3034ce5b1 # calbright-vpc-default
      subnetIds:
        - subnet-0529f716d4db99834 # calbright-subnet-private1-us-west-2a
        - subnet-02c89c171a3ab27af # calbright-subnet-private1-us-west-2b
        - subnet-0fec26aa4af7780ea # calbright-subnet-private1-us-west-2c
    tags: # Function specific tags
      Name: calbright-trigger-workflow-system-${env:ENVIRONMENT}-lambda
      Environment: ${env:ENVIRONMENT}
custom:
  pythonRequirements:
    useDownloadCache: false
    dockerizePip: false
    zip: true
