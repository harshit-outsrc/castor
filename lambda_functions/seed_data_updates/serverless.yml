service: seed-data-updates
plugins:
  - serverless-python-requirements
package:
  exclude:
    - env/**
    - node_modules/**
provider:
  name: aws
  stage: prod
  runtime: python3.9
  region: us-west-2
  timeout: 60 # in Seconds
  memorySize: 256 # in MB
  deploymentBucket:
    name: serverless.calbright.deploys # Deployment bucket name. Default is generated by the framework
  iamRoleStatements:
    - Effect: Allow
      Action:
      - s3:*
      Resource:
      - arn:aws:s3:::calbright-engineering/*
      - arn:aws:s3:::calbright-engineering
    - Effect: Allow
      Action:
        - kms:*
      Resource:
        - arn:aws:kms:us-west-2:523292522460:key/69776fb9-cbe2-489c-8efe-1dd896aeab68
    - Effect: Allow
      Action:
        - ssm:GetParameter
        - ssm:GetParameters
      Resource:
        - arn:aws:ssm:us-west-2:523292522460:parameter/psql.calbright.stage.write
        - arn:aws:ssm:us-west-2:523292522460:parameter/psql.calbright.prod.write
  stackTags:
    Name: seed-data-updates-lambda
functions:
  lambda:
    handler: main.run
    events:
      - s3:
          bucket: calbright-engineering
          event: s3:ObjectCreated:*
          existing: true
          rules:
            - prefix: seed_data/
            - suffix: .csv
    description: Lambda Listening to S3 Seed Data Updates
    vpc:
      securityGroupIds:
        - sg-03509e4c3034ce5b1 # calbright-vpc-default
      subnetIds:
        - subnet-0529f716d4db99834 # calbright-subnet-private1-us-west-2a
        - subnet-02c89c171a3ab27af # calbright-subnet-private1-us-west-2b
        - subnet-0fec26aa4af7780ea # calbright-subnet-private1-us-west-2c
custom:
  pythonRequirements:
    useDownloadCache: false
    useStaticCache: false
    dockerizePip: false
    zip: true
