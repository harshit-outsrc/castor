service: event-system
plugins:
  - serverless-python-requirements
  - '@digitalmaas/serverless-plugin-lambda-dead-letter'
package:
  exclude:
    - env/**
    - node_modules/**
provider:
  name: aws
  runtime: python3.9
  region: us-west-2
  stage: ${env:ENVIRONMENT}
  timeout: 60 # in Seconds
  memorySize: 256 # in MB
  deploymentBucket:
    name: serverless.calbright.deploys # Deployment bucket name. Default is generated by the framework
  iamRoleStatements:
    - Effect: Allow
      Action:
        - sqs:GetQueueUrl
        - sqs:SendMessage
      Resource:
        - arn:aws:sqs:us-west-2:523292522460:calbright_events_${env:ENVIRONMENT}
    - Effect: Allow
      Action:
        - kms:*
      Resource:
        - arn:aws:kms:us-west-2:523292522460:key/69776fb9-cbe2-489c-8efe-1dd896aeab68
    - Effect: Allow
      Action:
        - ssm:GetParameter
        - ssm:GetParameters
      Resource:
        - arn:aws:ssm:us-west-2:523292522460:parameter/hubspot.production
        - arn:aws:ssm:us-west-2:523292522460:parameter/calendly.production
        - arn:aws:ssm:us-west-2:523292522460:parameter/salesforce.propus.${env:ENVIRONMENT}
        - arn:aws:ssm:us-west-2:523292522460:parameter/gsuite.svc-engineering
        - arn:aws:ssm:us-west-2:523292522460:parameter/feature_flags.${env:ENVIRONMENT}
        - arn:aws:ssm:us-west-2:523292522460:parameter/gsuite.calbright-student.users
        - arn:aws:ssm:us-west-2:523292522460:parameter/gsuite.svc-engineering.licensing
        - arn:aws:ssm:us-west-2:523292522460:parameter/gsuite.svc-engineering.sheets
        - arn:aws:ssm:us-west-2:523292522460:parameter/google_maps.propus.stage
        - arn:aws:ssm:us-west-2:523292522460:parameter/slack.calbright-college.prod
        - arn:aws:ssm:us-west-2:523292522460:parameter/lms.strut.prod
        - arn:aws:ssm:us-west-2:523292522460:parameter/ironikus.prod
        - arn:aws:ssm:us-west-2:523292522460:parameter/pandadoc.production
        - arn:aws:ssm:us-west-2:523292522460:parameter/pandadoc.sandbox
        - arn:aws:ssm:us-west-2:523292522460:parameter/psql.calbright.${env:ENVIRONMENT}.write
        - arn:aws:ssm:us-west-2:523292522460:parameter/constants.${env:ENVIRONMENT}
        - arn:aws:ssm:us-west-2:523292522460:parameter/feature_flags.${env:ENVIRONMENT}
        - arn:aws:ssm:us-west-2:523292522460:parameter/canvas.${env:ENVIRONMENT}.token
        - arn:aws:ssm:us-west-2:523292522460:parameter/tangoe.${env:ENVIRONMENT}
    - Effect: Allow
      Action:
        - sqs:*
      Resource:
        - arn:aws:sqs:us-west-2:523292522460:calbright_events_${env:ENVIRONMENT}_dlq
  stackTags:
    Name: event-system-${env:ENVIRONMENT}-lambda
    Environment: ${env:ENVIRONMENT}
functions:
  lambda:
    handler: main.run
    deadLetter:
      targetArn: arn:aws:sqs:us-west-2:523292522460:calbright_events_${env:ENVIRONMENT}_dlq
    reservedConcurrency: 8
    events:
      - sqs: arn:aws:sqs:us-west-2:523292522460:calbright_events_${env:ENVIRONMENT}
    environment:
      ENV: ${env:ENVIRONMENT}
      PRINT_EVENT: true
    description: (${env:ENVIRONMENT}) EventSystem listening to Event System SQS Queues and other triggers
    vpc:
      securityGroupIds:
        - sg-03509e4c3034ce5b1 # calbright-vpc-default
      subnetIds:
        - subnet-0529f716d4db99834 # calbright-subnet-private1-us-west-2a
        - subnet-02c89c171a3ab27af # calbright-subnet-private1-us-west-2b
        - subnet-0fec26aa4af7780ea # calbright-subnet-private1-us-west-2c
custom:
  pythonRequirements:
    useDownloadCache: false
    useStaticCache: false
    dockerizePip: false
    zip: true
